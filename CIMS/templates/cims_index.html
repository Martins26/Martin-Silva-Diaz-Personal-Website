<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portfolio Vitals Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { padding: 1.5rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    textarea { font-family: inherit; }
    .small-muted { font-size: .9rem; color: #6c757d; }
    .badge-pill { border-radius: 999px; }
    .table-fixed { table-layout: fixed; }
  </style>
</head>
<body>
  <h1 class="mb-3">Portfolio Vitals Manager</h1>
  <p class="text-muted">Create portfolios with either <strong>weights</strong> or <strong>shares × last_price</strong>. Then view vitals, find similar portfolios, and download a PDF.</p>

  <!-- Create Portfolio -->
  <section class="mb-4">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Add Portfolio</h5>
        <form id="portfolioForm" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Owner</label>
            <input class="form-control" name="owner" placeholder="me" required />
          </div>
          <div class="col-md-4">
            <label class="form-label">Name</label>
            <input class="form-control" name="name" placeholder="Core" />
          </div>
          <div class="col-md-4">
            <label class="form-label">Currency</label>
            <input class="form-control" name="currency" placeholder="USD" />
          </div>

          <div class="col-12">
            <label class="form-label">Positions JSON</label>
            <textarea class="form-control mono" rows="7" id="positionsJson" required>[{
  "ticker": "VTI", "weight": 0.50, "expense_ratio": 0.0003, "dividend_yield": 0.015, "sector": "Broad", "region": "US"
}, {
  "ticker": "VEA", "weight": 0.30, "expense_ratio": 0.0005, "dividend_yield": 0.028, "sector": "Broad", "region": "Intl"
}, {
  "ticker": "BND", "weight": 0.20, "expense_ratio": 0.0004, "dividend_yield": 0.03,  "sector": "Bonds", "region": "US"
}]</textarea>
            <div class="small-muted mt-1">Alternatively, provide <code>shares</code> and <code>last_price</code> in each object and omit <code>weight</code>; weights will be auto-derived.</div>
          </div>

          <div class="col-12">
            <label class="form-label">Benchmark Sector Weights JSON (optional)</label>
            <textarea class="form-control mono" rows="4" id="benchmarkJson">{
  "Tech": 0.25, "Financials": 0.13, "HC": 0.13, "ConsDisc": 0.10
}</textarea>
            <div class="small-muted mt-1">Used for overweight/underweight alerts (keys must match your sector labels if you want exact comparisons).</div>
          </div>

          <div class="col-12">
            <button class="btn btn-primary" type="submit">Create Portfolio</button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <!-- Portfolios List -->
  <section class="mb-4">
    <div class="d-flex align-items-center mb-2">
      <h5 class="me-3 mb-0">Your Portfolios</h5>
      <button class="btn btn-sm btn-outline-secondary" id="refreshBtn">Refresh</button>
    </div>
    <div class="table-responsive">
      <table class="table table-striped align-middle table-fixed" id="portfolioTable">
        <thead>
          <tr>
            <th style="width:18%">Name</th>
            <th style="width:12%">Owner</th>
            <th style="width:10%">Currency</th>
            <th style="width:40%">Positions (tickers)</th>
            <th style="width:20%">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Vitals / Similar / Report -->
  <section class="row g-4">
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">Portfolio Vitals</h5>
          <div class="input-group mb-2">
            <select id="vitalsSelect" class="form-select"></select>
            <button class="btn btn-outline-primary" id="vitalsBtn">Load</button>
          </div>
          <pre id="vitalsPre" class="mono bg-light p-3 rounded" style="min-height: 180px; white-space: pre-wrap"></pre>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">Find Similar Portfolios</h5>
          <div class="input-group mb-2">
            <select id="similarSelect" class="form-select"></select>
            <button class="btn btn-outline-secondary" id="similarBtn">Find</button>
          </div>
          <pre id="similarPre" class="mono bg-light p-3 rounded" style="min-height: 180px; white-space: pre-wrap"></pre>
        </div>
      </div>
    </div>
  </section>

  <section class="mt-4">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Report</h5>
        <div class="row g-2 align-items-center">
          <div class="col-md-6">
            <select id="reportSelect" class="form-select"></select>
          </div>
          <div class="col-md-3 form-check">
            <input class="form-check-input" type="checkbox" id="anonChk" />
            <label for="anonChk" class="form-check-label">Anonymize</label>
          </div>
          <div class="col-md-3">
            <button class="btn btn-success w-100" id="reportBtn">Download PDF</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    async function api(path, opts={}){
      const res = await fetch(path, opts);
      if(!res.ok){
        const text = await res.text();
        throw new Error(text || (res.status+": "+res.statusText));
      }
      const ct = res.headers.get('content-type') || '';
      if(ct.includes('application/json')) return res.json();
      return res;
    }

    async function loadPortfolios(){
      const data = await api('/portfolios');
      const tbody = document.querySelector('#portfolioTable tbody');
      const selects = [document.querySelector('#vitalsSelect'), document.querySelector('#similarSelect'), document.querySelector('#reportSelect')];
      tbody.innerHTML='';
      selects.forEach(s=> s.innerHTML = '');

      data.forEach(p=>{
        const tickers = (p.positions||[]).map(x=>x.ticker).join(', ');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="fw-semibold">${p.name||'—'}</td>
          <td>${p.owner||'—'}</td>
          <td>${p.currency||'—'}</td>
          <td class="text-truncate" title="${tickers}">${tickers}</td>
          <td>
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-outline-primary" onclick="loadVitals('${p.id}')">Vitals</button>
              <button class="btn btn-outline-secondary" onclick="findSimilar('${p.id}')">Similar</button>
              <button class="btn btn-outline-danger" onclick="deletePortfolio('${p.id}')">Delete</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
        selects.forEach(s=> s.innerHTML += `<option value="${p.id}">${p.name || p.id}</option>`);
      });
    }

    // Create portfolio
    document.getElementById('portfolioForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      let positions, benchmark;
      try { positions = JSON.parse(document.getElementById('positionsJson').value || '[]'); } catch(err){ return alert('Positions JSON invalid: '+err.message); }
      try { benchmark = JSON.parse(document.getElementById('benchmarkJson').value || '{}'); } catch(err){ return alert('Benchmark JSON invalid: '+err.message); }

      const payload = {
        owner: fd.get('owner') || 'user',
        name: fd.get('name') || undefined,
        currency: fd.get('currency') || 'USD',
        positions: positions,
        benchmark_weights: benchmark
      };

      await api('/portfolios', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      e.target.reset();
      // restore defaults after reset
      document.getElementById('positionsJson').value = JSON.stringify(positions, null, 2);
      document.getElementById('benchmarkJson').value = JSON.stringify(benchmark, null, 2);
      loadPortfolios();
    });

    async function deletePortfolio(id){
      if(!confirm('Delete this portfolio?')) return;
      await api(`/portfolios/${id}`, { method:'DELETE' });
      loadPortfolios();
    }

    async function loadVitals(id){
      const pid = id || document.getElementById('vitalsSelect').value;
      if(!pid) return;
      const data = await api(`/portfolios/${pid}/vitals`);
      document.getElementById('vitalsPre').textContent = JSON.stringify(data, null, 2);
    }

    async function findSimilar(id){
      const pid = id || document.getElementById('similarSelect').value;
      if(!pid) return;
      const data = await api(`/similar/portfolio/${pid}`);
      document.getElementById('similarPre').textContent = JSON.stringify(data, null, 2);
    }

    document.getElementById('vitalsBtn').addEventListener('click', ()=> loadVitals());
    document.getElementById('similarBtn').addEventListener('click', ()=> findSimilar());

    // Report
    document.getElementById('reportBtn').addEventListener('click', ()=>{
      const pid = document.getElementById('reportSelect').value;
      const anon = document.getElementById('anonChk').checked;
      if(!pid) return;
      const url = `/report?portfolio_id=${encodeURIComponent(pid)}${anon ? '&anonymize=true' : ''}`;
      window.open(url, '_blank');
    });

    document.getElementById('refreshBtn').addEventListener('click', loadPortfolios);
    loadPortfolios();
  </script>
</body>
</html>
