<!DOCTYPE html>
<html>
<head>
    <title>Client Portfolio Manager</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="p-4">
    <h1>Client Portfolio Manager</h1>

    <!-- Add Client Form -->
    <div class="mb-4">
        <h3>Add Client</h3>
        <form id="clientForm" class="row g-3">
            <input type="text" class="form-control" placeholder="First Name" name="first_name" required>
            <input type="text" class="form-control" placeholder="Last Name" name="last_name" required>
            <input type="email" class="form-control" placeholder="Email" name="email" required>
            <input type="text" class="form-control" placeholder="Phone" name="phone" required>
            <input type="number" step="0.01" class="form-control" placeholder="Portfolio Score" name="portfolio_score" required>
            <button class="btn btn-primary mt-2" type="submit">Add Client</button>
        </form>
    </div>

    <!-- Client List -->
    <div>
        <h3>Clients</h3>
        <table class="table table-bordered" id="clientTable">
            <thead>
                <tr>
                    <th>Name</th><th>Email</th><th>Phone</th><th>Score</th><th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Stats -->
    <div>
        <h3>Statistics</h3>
        <button class="btn btn-info" onclick="loadStats()">Load Stats</button>
        <pre id="statsDisplay"></pre>
    </div>

    <!-- Similarity -->
    <div>
        <h3>Find Similar Clients</h3>
        <select id="similarSelect" class="form-select"></select>
        <button class="btn btn-secondary mt-2" onclick="findSimilar()">Find</button>
        <pre id="similarDisplay"></pre>
    </div>

    <!-- Report -->
    <div>
        <h3>Download Report</h3>
        <button class="btn btn-success" onclick="window.open('/report')">Download</button>
        <button class="btn btn-warning" onclick="window.open('/report?anonymize=true')">Download (Anonymized)</button>
    </div>

<script>
async function loadClients() {
    let res = await fetch("/clients");
    let data = await res.json();
    let tableBody = document.querySelector("#clientTable tbody");
    tableBody.innerHTML = "";
    let select = document.querySelector("#similarSelect");
    select.innerHTML = "";
    data.forEach(c => {
        tableBody.innerHTML += `
            <tr>
                <td>${c.first_name} ${c.last_name}</td>
                <td>${c.email}</td>
                <td>${c.phone}</td>
                <td>${c.portfolio_score}</td>
                <td><button class="btn btn-danger btn-sm" onclick="deleteClient('${c.id}')">Delete</button></td>
            </tr>
        `;
        select.innerHTML += `<option value="${c.id}">${c.first_name} ${c.last_name}</option>`;
    });
}

document.querySelector("#clientForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    let formData = new FormData(e.target);
    let data = {};
    formData.forEach((v, k) => data[k] = v);
    await fetch("/clients", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
    });
    e.target.reset();
    loadClients();
});

async function deleteClient(id) {
    await fetch(`/clients/${id}`, { method: "DELETE" });
    loadClients();
}

async function loadStats() {
    let res = await fetch("/stats");
    let data = await res.json();
    document.querySelector("#statsDisplay").textContent = JSON.stringify(data, null, 2);
}

async function findSimilar() {
    let id = document.querySelector("#similarSelect").value;
    let res = await fetch(`/similar/${id}`);
    let data = await res.json();
    document.querySelector("#similarDisplay").textContent = JSON.stringify(data, null, 2);
}

loadClients();
</script>
</body>
</html>
